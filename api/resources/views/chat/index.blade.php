<html><head>
    <meta charset="UTF-8">
    <meta name="csrf-token" content="evVXnmR0Msg17dWixAQzZc0bAUCxhXZm9Z3gb0Lt">
    <title>Talk Message565656</title>


    <link rel="stylesheet" href="/chat/css/reset.css">




    <!--
     <link rel="stylesheet prefetch" href="http://10.0.0.64:5001/font-awesome/css/font-awesome.min.css">
    <link rel="stylesheet prefetch" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css">
   -->
    <link rel="stylesheet" href="/chat/css/style.css">




</head>

<body>
<div class="header">
    <div class="container header-brand">
        <a href="http://127.0.0.1:8001/home" class="brand">Talk Message</a>
    </div>
</div>
<div class="container clearfix body">
    <div class="people-list" id="people-list">
        <div class="search" style="text-align: center">
            <a href="http://127.0.0.1:8001/home" style="font-size:16px; text-decoration:none; color: white;"><i class="fa fa-user"></i> lg</a>
        </div>
        <ul class="list">
            <li class="clearfix">
                <a href="http://127.0.0.1:8001/message/1">
                    <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAwCAYAAABXAvmHAAAACXBIWXMAAA7EAAAOxAGVKw4bAAAD+ElEQVRogdWaT2gcVRzHP79xG9YSQZeaXCRIB0qVHd091YDEECj0KKKBJgY64qHQcw9SPGiRQi2K4MEcZGLEwsY/vfRqKPinKUJdMku8OEG2UnULLjRSQg778zCzYXezf2Z3JsnO57Tz3m/efH/73rz3e783QgxYpn0MmAYmQXMgE8Ax4EnfQv8DqQBlYB34BVh1Ped+1GfLoDdapj0KzAFnQadAjAGaWVO0ICrL7qbz7yA6+nbAOm5nEN4B3mb3H46GwiPQZUEu99sroR2wTNsAPQ/yATEJb0XhkcAV4KrrOTth7gnlQNa0JwS+Al6OIjAsihYFWXA9p9TLtqcDlmlPA98CmRi0hSbojQXXc77rZvdYt0rLtN8ECsATcYoLg8AR0DfGMrmHlWpxrZNdRwd88foFyJH9kRgGEUHOjGfyW5Vq8XY7i7YOBMOmcLjiG9HT45n8RqVa3Git2fMOBC/srxzwmA/BNnDK9Zz1xsKmxccybSOYbYZNPEAatJA17XRjYcvqqec5oKlyMOSkoO82ldR/BCusxz4tUjGyA/qc6y1tQmMP+OHBsIsHGAF5r34hsBuY3SMZDgDsKGqWvKU/6z0wR3LEA4wI8hZAKig4G7XF2blpXpudAuD2Txt88uE3UZvsxTzwfsrfjOhUhK0BAE+PPcXz2WcBuFd+EF1eb05Ypp01gOkBNyPDwIwBTB62ighMGv4eNqlozgg24IlEkQkDP3uQSASOGiRr/t9DUmefXQw/6ZRcjCBjllS2Dfx0X1IpG/i5yoSi6yn8RGusvDLzIt///FHH+htf/8CnH9+I4UlyJwWsxtBSE+n0COn0SMf60dHH43rUasr1nPuWaa8BL0Vp6UGlykbpj1C2f/81UCK6CUXLJW/pbiq4KAgSyYGV67dYuX4rsrCwCLICwUImKst+ijspaA1lEQIH/MMFXT5cUf0gN91N53doCCUEuZyMXtAacKl+tZsbrVSLW+OZvAHMHIassCgslrwlp37dGsxdVbR4wJpCo2hZkIuNZU0OuJ6zI8jCcA4lrYHMu57TFHzuCaddzykJLARjbYiQCyXP+bG1tO35QKVa/G0sk3soyJn9FxaKa67nXGlX0fGEplItro1n8lugp0GiJY2icc31nIudKsMc8r0OfAmke9nGi9ZALrie81k3q1D/rGXaL4AWQE7GI647ipZB5tuN+Va6nlLWqVSL/4xl8p8LaoCcCntf/2hNYVGQV0uev9L2ov9PDcxzx4P8/CzQOWbuC62B3AQuhTncbmTglzNrnnsmSHHPAycGaSNYmFZQFuuxTb/EMrtYpp3FD0EmQXOKTAgcbTHbBsqg6yB38D+3uRv12f8DBUUyDmQfTu8AAAAASUVORK5CYII=" alt="avatar">
                    <div class="about">
                        <div class="name">lg</div>
                        <div class="status">
                            <span class="fa fa-reply"></span>
                            <span>电饭锅蛋糕
</span>
                        </div>
                    </div>
                </a>
            </li>

        </ul>
    </div>

    <div class="chat">
        <div class="chat-header clearfix">
            <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAwCAYAAABXAvmHAAAACXBIWXMAAA7EAAAOxAGVKw4bAAAD+ElEQVRogdWaT2gcVRzHP79xG9YSQZeaXCRIB0qVHd091YDEECj0KKKBJgY64qHQcw9SPGiRQi2K4MEcZGLEwsY/vfRqKPinKUJdMku8OEG2UnULLjRSQg778zCzYXezf2Z3JsnO57Tz3m/efH/73rz3e783QgxYpn0MmAYmQXMgE8Ax4EnfQv8DqQBlYB34BVh1Ped+1GfLoDdapj0KzAFnQadAjAGaWVO0ICrL7qbz7yA6+nbAOm5nEN4B3mb3H46GwiPQZUEu99sroR2wTNsAPQ/yATEJb0XhkcAV4KrrOTth7gnlQNa0JwS+Al6OIjAsihYFWXA9p9TLtqcDlmlPA98CmRi0hSbojQXXc77rZvdYt0rLtN8ECsATcYoLg8AR0DfGMrmHlWpxrZNdRwd88foFyJH9kRgGEUHOjGfyW5Vq8XY7i7YOBMOmcLjiG9HT45n8RqVa3Git2fMOBC/srxzwmA/BNnDK9Zz1xsKmxccybSOYbYZNPEAatJA17XRjYcvqqec5oKlyMOSkoO82ldR/BCusxz4tUjGyA/qc6y1tQmMP+OHBsIsHGAF5r34hsBuY3SMZDgDsKGqWvKU/6z0wR3LEA4wI8hZAKig4G7XF2blpXpudAuD2Txt88uE3UZvsxTzwfsrfjOhUhK0BAE+PPcXz2WcBuFd+EF1eb05Ypp01gOkBNyPDwIwBTB62ighMGv4eNqlozgg24IlEkQkDP3uQSASOGiRr/t9DUmefXQw/6ZRcjCBjllS2Dfx0X1IpG/i5yoSi6yn8RGusvDLzIt///FHH+htf/8CnH9+I4UlyJwWsxtBSE+n0COn0SMf60dHH43rUasr1nPuWaa8BL0Vp6UGlykbpj1C2f/81UCK6CUXLJW/pbiq4KAgSyYGV67dYuX4rsrCwCLICwUImKst+ijspaA1lEQIH/MMFXT5cUf0gN91N53doCCUEuZyMXtAacKl+tZsbrVSLW+OZvAHMHIassCgslrwlp37dGsxdVbR4wJpCo2hZkIuNZU0OuJ6zI8jCcA4lrYHMu57TFHzuCaddzykJLARjbYiQCyXP+bG1tO35QKVa/G0sk3soyJn9FxaKa67nXGlX0fGEplItro1n8lugp0GiJY2icc31nIudKsMc8r0OfAmke9nGi9ZALrie81k3q1D/rGXaL4AWQE7GI647ipZB5tuN+Va6nlLWqVSL/4xl8p8LaoCcCntf/2hNYVGQV0uev9L2ov9PDcxzx4P8/CzQOWbuC62B3AQuhTncbmTglzNrnnsmSHHPAycGaSNYmFZQFuuxTb/EMrtYpp3FD0EmQXOKTAgcbTHbBsqg6yB38D+3uRv12f8DBUUyDmQfTu8AAAAASUVORK5CYII=" alt="avatar">
            <div class="chat-about">
                <div class="chat-with">Chat with lg</div>
            </div>
            <i class="fa fa-star"></i>
        </div> <!-- end chat-header -->

        <div class="chat-history">
            <ul id="talkMessages">

                <li class="clearfix" id="message-1">
                    <div class="message-data align-right">
                        <span class="message-data-time">1 day ago</span> &nbsp; &nbsp;
                        <span class="message-data-name">lg</span>
                        <a href="#" class="talkDeleteMessage" data-message-id="1" title="Delete Message"><i class="fa fa-close"></i></a>
                    </div>
                    <div class="message other-message float-right">
                        3434
                    </div>
                </li>

            </ul>

        </div> <!-- end chat-history -->


        <div class="chat-message clearfix">

                <textarea name="message-data" id="textarea" placeholder="Type your message" rows="3"></textarea>

                <button type="button" id="sendButton">Send</button>


        </div> <!-- end chat-message -->

    </div> <!-- end chat -->

</div> <!-- end container -->



<script src="http://10.0.0.64:5001/js/jquery-1.9.1.min.js"></script>




<script>
    var show = function(data) {
        alert(data.sender.name + " - '" + data.message + "'");
    }

    var msgshow = function(data) {
        var html = '<li >' +
            '<div class="message-data">' +
            '<span class="message-data-name"> <a href="#" class="talkDeleteMessage"  title="Delete Messag"><i class="fa fa-close" style="margin-right: 3px;"></i></a>' + data.from_user_name + '</span>' +
            '<span class="message-data-time">'+data.time+'</span>' +
            '</div>' +
            '<div class="message my-message">' +
            data.content +
            '</div>' +
            '</li>';

        $('#talkMessages').append(html);
    }

</script>

<script>
    var ws, name, client_list={},client_id,group_id,api_token,user_id;


    // 连接服务端
    function connect() {
        // 创建websocket
        ws = new WebSocket("ws://"+document.domain+":7272");
        // 当socket连接打开时，输入用户名
      //  ws.onopen = onopen;
        // 当有消息时根据消息类型显示不同信息
        ws.onmessage = onmessage;
        ws.onclose = function() {
            console.log("连接关闭，定时重连");
            connect();
        };
        ws.onerror = function() {
            console.log("出现错误");
        };
    }


    $(document).ready(function(){
        api_token = window.localStorage.getItem("api_token");
        user_id = window.localStorage.getItem("user_id");
        if(!api_token || !user_id){
            window.location.href="/login.html"
            return
        }

        connect();
    });
   /* // 连接建立时发送登录信息
    function onopen()
    {
        if(!name)
        {
            show_prompt();
        }
        // 登录
        var login_data = '{"type":"login","client_name":"'+name.replace(/"/g, '\\"')+'"}';
        console.log("websocket握手成功，发送登录数据:"+login_data);
        ws.send(login_data);
    }*/
    // 输入姓名
    function show_prompt(){
        name = prompt('输入你的名字：', '');
        if(!name || name=='null'){
            name = '游客';
        }
    }
    function onmessage(e)
    {

        var data = JSON.parse(e.data);
        switch(data['type']){
            case 'init':
                // 利用jquery发起ajax请求，将client_id发给后端进行uid绑定
                $.ajax("/api/talk/bind/",{
                    type:"post",
                    headers:{
                        Authorization:"Bearer "+api_token,
                        TUID:user_id,
                    },
                    dataType:'json',
                    data:{client_id:data.client_id},
                    success:function(res){

                        if(res.statusCode == 0){

                            group_id =  res.data.group_id;
                            console.dir("bind 成功")
                        }else{
                            alert("bind 失败")
                        }
                    },
                    error:function(XMLHttpRequest, textStatus, errorThrown){
                        if(XMLHttpRequest.status == 401){
                            alert("登录过期")
                            window.location.href="/login.html"
                        };
                    }
                });




                client_id = data.client_id;
                break;
            // 服务端ping客户端
            case 'ping':
                ws.send('{"type":"pong"}');
                break;;


            // 发言
            case 'say':
                //{"type":"say","from_client_id":xxx,"to_client_id":"all/client_id","content":"xxx","time":"xxx"}
                console.info("say===")
                console.dir(data)
                msgshow(data);
                break;
            // 用户退出 更新用户列表
            case 'logout':
                //{"type":"logout","client_id":xxx,"time":"xxx"}
                say(data['from_client_id'], data['from_client_name'], data['from_client_name']+' 退出了', data['time']);
                delete client_list[data['from_client_id']];

        }
    }
    // 提交对话
    $('#sendButton').on('click', function () {

        var input = document.getElementById("textarea");

        $.ajax("/api/talk/send/",{
            type:"post",
            headers:{
                Authorization:"Bearer "+api_token,
                TUID:user_id,
            },
            dataType:'json',
            data: {
                "type":"say",
                "client_id":client_id,
                "content":input.value
            },
            success:function(res){

                if(res.statusCode == 0){

                }else{
                    alert("发送 失败")
                }
            },
            error:function(XMLHttpRequest, textStatus, errorThrown){
                if(XMLHttpRequest.status == 401){
                    alert("登录过期")
                    window.location.href="/login.html"
                };
            }
        });
       /* $.post('/api/chats/send/', {
            "type":"say",
            "to_group_id":group_id,
            "client_id":client_id,
            "s":name,
            "content":input.value
        }, function(res){

            group_id =  res.data.group_id;
        }, 'json');*/


        input.value = "";
        input.focus();
        return false;
    });

</script>




</body></html>